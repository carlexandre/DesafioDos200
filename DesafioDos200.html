<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio dos 200</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Animações de Transição de Página */
        .page-enter {
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .number-box { transition: all 0.2s; }
        .number-box:active { transform: scale(0.95); }
        .selected { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="text-slate-800 bg-slate-100 min-h-screen">

    <!-- Config Alert -->
    <div id="config-warning" class="hidden fixed top-0 left-0 w-full bg-yellow-400 text-yellow-900 p-2 text-center text-sm z-50 font-bold shadow-md">
        <i class="fas fa-exclamation-triangle"></i> Configure o Firebase no código para funcionar!
    </div>

    <!-- O CONTEÚDO DA PÁGINA SERÁ INJETADO AQUI -->
    <div id="app-root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";


        // CONFIGURAÇÃO (Firebase)
    
        const manualConfig = null; // COLE SUA CONFIGURAÇÃO AQUI SE FOR HOSPEDAR

        let app, db, auth, currentUser;
        let unsubscribeDoc = null;
        let currentChallengeId = localStorage.getItem('challenge_id');

        // Inicialização
        function initFirebase() {
            let config = manualConfig;
            
            // Lógica para funcionar no Preview do Canvas
            if (typeof __firebase_config !== 'undefined') {
                config = JSON.parse(__firebase_config);
            }

            if (!config) {
                document.getElementById('config-warning').classList.remove('hidden');
                return;
            }

            app = initializeApp(config);
            db = getFirestore(app);
            auth = getAuth(app);

            // Observador de Autenticação
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                router(); // Re-executa o roteador quando o status do login muda
            });
            
            // Auto-login no Preview
            if (typeof __initial_auth_token !== 'undefined' && !manualConfig) {
                signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
            }
        }

        // ROTEADOR (Gerencia as "Páginas")
        
        // Escuta mudanças na URL (ex: #cadastro, #app)
        window.addEventListener('hashchange', router);
        window.addEventListener('load', initFirebase);

        function router() {
            const hash = window.location.hash || '#login';
            const root = document.getElementById('app-root');

            // Proteção de Rotas
            if (!currentUser && hash === '#app') {
                window.location.hash = '#login';
                return;
            }
            
            if (currentUser && (hash === '#login' || hash === '#cadastro')) {
                // Se já tem usuário e código de desafio, vai para o app
                // Se não tem código, precisa selecionar
                if (currentChallengeId) {
                    window.location.hash = '#app';
                } else {
                    window.location.hash = '#selecao';
                }
                return;
            }

            // Renderização das Páginas
            switch(hash) {
                case '#login':
                    renderLogin(root);
                    break;
                case '#cadastro':
                    renderRegister(root);
                    break;
                case '#selecao':
                    renderSelection(root);
                    break;
                case '#app':
                    renderApp(root);
                    break;
                default:
                    window.location.hash = '#login';
            }
        }

        // PÁGINAS (VIEWS)

        // --- PÁGINA DE LOGIN ---
        function renderLogin(container) {
            container.innerHTML = `
                <div class="page-enter min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-slate-200">
                        <div class="text-center mb-8">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-emerald-100 text-emerald-600 mb-4">
                                <i class="fas fa-sign-in-alt text-2xl"></i>
                            </div>
                            <h1 class="text-2xl font-bold text-slate-800">Bem-vindo de volta</h1>
                            <p class="text-slate-500 text-sm">Acesse seu desafio financeiro</p>
                        </div>
                        <form id="login-form" class="space-y-4">
                            <input type="email" id="email" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="E-mail" required>
                            <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Senha" required>
                            <div id="error-msg" class="hidden text-red-500 text-sm p-2 bg-red-50 rounded"></div>
                            <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-emerald-200">
                                Entrar
                            </button>
                        </form>
                        <div class="mt-6 text-center text-sm text-slate-500">
                            Não tem conta? <a href="#cadastro" class="text-emerald-600 font-bold hover:underline">Criar conta</a>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                const originalText = btn.innerText;
                btn.disabled = true; btn.innerText = 'Entrando...';

                try {
                    await signInWithEmailAndPassword(auth, 
                        document.getElementById('email').value, 
                        document.getElementById('password').value
                    );
                    // O router redirecionará automaticamente
                } catch (error) {
                    showError(error);
                    btn.disabled = false; btn.innerText = originalText;
                }
            });
        }

        // --- PÁGINA DE CADASTRO ---
        function renderRegister(container) {
            container.innerHTML = `
                <div class="page-enter min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-slate-200">
                        <div class="text-center mb-8">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 text-blue-600 mb-4">
                                <i class="fas fa-user-plus text-2xl"></i>
                            </div>
                            <h1 class="text-2xl font-bold text-slate-800">Criar Conta</h1>
                            <p class="text-slate-500 text-sm">Comece a poupar hoje mesmo</p>
                        </div>
                        <form id="register-form" class="space-y-4">
                            <input type="email" id="reg-email" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Seu melhor e-mail" required>
                            <input type="password" id="reg-password" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Senha (mín. 6 caracteres)" required>
                            <div id="error-msg" class="hidden text-red-500 text-sm p-2 bg-red-50 rounded"></div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-blue-200">
                                Cadastrar
                            </button>
                        </form>
                        <div class="mt-6 text-center text-sm text-slate-500">
                            Já tem conta? <a href="#login" class="text-blue-600 font-bold hover:underline">Fazer Login</a>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                btn.disabled = true; btn.innerText = 'Criando...';

                try {
                    await createUserWithEmailAndPassword(auth, 
                        document.getElementById('reg-email').value, 
                        document.getElementById('reg-password').value
                    );
                } catch (error) {
                    showError(error);
                    btn.disabled = false; btn.innerText = 'Cadastrar';
                }
            });
        }

        // --- PÁGINA DE SELEÇÃO DE DESAFIO ---
        function renderSelection(container) {
            container.innerHTML = `
                <div class="page-enter min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-slate-200 text-center">
                        <h2 class="text-xl font-bold text-slate-800 mb-2">Código do Desafio</h2>
                        <p class="text-slate-500 text-sm mb-6">Use o mesmo código para compartilhar com a família ou crie um novo.</p>
                        
                        <div class="relative mb-6">
                            <input type="text" id="challenge-code" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none uppercase tracking-widest font-bold text-center" placeholder="EX: MINHA-CASA">
                        </div>

                        <button id="enter-challenge-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition-colors">
                            Acessar <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                        
                        <button id="logout-btn" class="mt-4 text-sm text-slate-400 hover:text-red-500">Sair da conta</button>
                    </div>
                </div>
            `;

            document.getElementById('enter-challenge-btn').addEventListener('click', () => {
                const code = document.getElementById('challenge-code').value.trim().toUpperCase().replace(/\s+/g, '-');
                if (code.length < 3) return alert('O código deve ter pelo menos 3 letras');
                
                localStorage.setItem('challenge_id', code);
                currentChallengeId = code;
                window.location.hash = '#app';
            });

            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        }

        // --- PÁGINA PRINCIPAL ---
        function renderApp(container) {
            const appIdStr = currentChallengeId || 'DESCONHECIDO';
            
            container.innerHTML = `
                <div class="page-enter min-h-screen flex flex-col items-center py-6 px-4 pb-20">
                    <header class="w-full max-w-4xl bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6 sticky top-2 z-20">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i class="fas fa-bullseye text-emerald-500"></i> ${appIdStr}
                                </h1>
                                <button id="change-challenge" class="text-xs text-slate-400 underline hover:text-emerald-600">Trocar desafio</button>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-slate-500 uppercase font-semibold">Guardado</div>
                                <div id="total-display" class="text-2xl font-bold text-emerald-600">R$ 0,00</div>
                            </div>
                        </div>

                        <div class="relative pt-1">
                            <div class="overflow-hidden h-3 mb-2 text-xs flex rounded-full bg-slate-200">
                                <div id="progress-bar" style="width:0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-emerald-500 transition-all duration-500"></div>
                            </div>
                            <div class="flex justify-between text-xs text-emerald-600 font-semibold">
                                <span id="progress-text">0%</span>
                                <span id="remaining-text">Falta R$ 20.100</span>
                            </div>
                        </div>
                    </header>

                    <div id="loader" class="py-10 text-slate-400 flex flex-col items-center">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i> Carregando dados...
                    </div>

                    <main id="grid-content" class="w-full max-w-4xl hidden grid grid-cols-4 sm:grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-3">
                        <!-- Botões gerados aqui -->
                    </main>

                    <button id="logout-app" class="mt-8 text-slate-400 hover:text-red-500 text-sm">
                        <i class="fas fa-sign-out-alt"></i> Sair do sistema
                    </button>
                </div>
            `;

            // Listeners da Página Principal
            document.getElementById('change-challenge').addEventListener('click', () => {
                localStorage.removeItem('challenge_id');
                currentChallengeId = null;
                if(unsubscribeDoc) unsubscribeDoc();
                window.location.hash = '#selecao';
            });

            document.getElementById('logout-app').addEventListener('click', () => {
                localStorage.removeItem('challenge_id');
                currentChallengeId = null;
                if(unsubscribeDoc) unsubscribeDoc();
                signOut(auth);
            });

            startLiveSync();
        }

        //  LÓGICA DO COFRE

        const TOTAL_NUMBERS = 200;
        const totalPossible = (TOTAL_NUMBERS * (TOTAL_NUMBERS + 1)) / 2;
        const appArtifactId = typeof __app_id !== 'undefined' ? __app_id : 'family-savings-app';

        function startLiveSync() {
            if (!currentChallengeId) return;

            // Gera botões vazios primeiro
            const grid = document.getElementById('grid-content');
            grid.innerHTML = '';
            for (let i = 1; i <= TOTAL_NUMBERS; i++) {
                const btn = document.createElement('button');
                btn.id = `btn-${i}`;
                btn.className = "number-box h-10 sm:h-12 rounded-lg font-bold border bg-white text-slate-600 border-slate-200 hover:bg-emerald-50";
                btn.textContent = i;
                btn.onclick = () => handleNumberClick(i);
                grid.appendChild(btn);
            }

            // Conecta ao Firestore
            const docRef = doc(db, 'artifacts', appArtifactId, 'public', 'data', `board_${currentChallengeId}`);
            
            if (unsubscribeDoc) unsubscribeDoc();

            unsubscribeDoc = onSnapshot(docRef, (snap) => {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('grid-content').classList.remove('hidden');

                if (snap.exists()) {
                    const data = snap.data();
                    updateUI(new Set(data.selectedNumbers || []));
                } else {
                    setDoc(docRef, { selectedNumbers: [], createdBy: auth.currentUser.uid });
                }
            });
        }

        function updateUI(selectedSet) {
            // Atualiza Grid
            for (let i = 1; i <= TOTAL_NUMBERS; i++) {
                const btn = document.getElementById(`btn-${i}`);
                if (!btn) continue;
                
                const isSelected = selectedSet.has(i);
                const currentClass = btn.className;
                
                if (isSelected && !currentClass.includes('bg-emerald-500')) {
                    btn.className = "number-box h-10 sm:h-12 rounded-lg font-bold border bg-emerald-500 text-white border-emerald-600 shadow-md transform scale-100 selected";
                } else if (!isSelected && currentClass.includes('bg-emerald-500')) {
                    btn.className = "number-box h-10 sm:h-12 rounded-lg font-bold border bg-white text-slate-600 border-slate-200 hover:bg-emerald-50";
                }
            }

            // Atualiza Totais
            const total = [...selectedSet].reduce((a, b) => a + b, 0);
            const percent = (total / totalPossible) * 100;
            const remaining = totalPossible - total;
            const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

            document.getElementById('total-display').textContent = fmt.format(total);
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `${percent.toFixed(1)}%`;
            document.getElementById('remaining-text').textContent = `Falta ${fmt.format(remaining)}`;
        }

        async function handleNumberClick(num) {
            const btn = document.getElementById(`btn-${num}`);
            const isSelected = btn.className.includes('bg-emerald-500');
            const docRef = doc(db, 'artifacts', appArtifactId, 'public', 'data', `board_${currentChallengeId}`);

            try {
                if (isSelected) {
                    await updateDoc(docRef, { selectedNumbers: arrayRemove(num) });
                } else {
                    await updateDoc(docRef, { selectedNumbers: arrayUnion(num) });
                    if (navigator.vibrate) navigator.vibrate(10);
                }
            } catch (err) {
                console.error("Erro:", err);
            }
        }

        function showError(error) {
            const div = document.getElementById('error-msg');
            let msg = 'Erro desconhecido';
            switch(error.code) {
                case 'auth/invalid-email': msg = 'E-mail inválido.'; break;
                case 'auth/user-not-found': msg = 'Usuário não encontrado.'; break;
                case 'auth/wrong-password': msg = 'Senha incorreta.'; break;
                case 'auth/email-already-in-use': msg = 'E-mail já em uso.'; break;
                case 'auth/weak-password': msg = 'Senha muito fraca.'; break;
            }
            div.textContent = msg;
            div.classList.remove('hidden');
        }

    </script>
</body>
</html>